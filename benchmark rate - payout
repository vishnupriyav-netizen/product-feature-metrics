WITH benchmark_accounts AS (
    SELECT distinct account_id
    FROM
    (
        SELECT account_id, 'markup' as type, markup_pct as mark_pct
        FROM datalake.clean_config_account_fx_markup
        WHERE apply_benchmark_spread = 'true'

        UNION ALL

        SELECT account_id, 'markdown' as type, markdown_pct as mark_pct
        FROM datalake.clean_config_account_fx_markdown
        WHERE apply_benchmark_spread = 'true'
    )
    WHERE account_id NOT IN (
        'acc_cpmje7v90nmekbr0i66g',
        'acc_d51q8e1r92cb83pujstg',
        'acc_d5q65emimjo249spka40'
    )
),

 payout_info as (
select business_name, account_id, payout_id, payout_attempt_id, payout_created_at, balance_currency, payout_currency, destination_currency, 

CASE
    WHEN payout_currency in ('usd', 'USD') then payout_amount / 100.0
   WHEN payout_currency in ('btc','BTC') then (payout_amount / 100000000.0) * cast(rate_in_pcy_to_usd as Float64)
    ELSE (payout_amount / 100.0) * CAST(rate_in_pcy_to_usd AS Float64)
    END as tpv_usd,

1 - (toFloat64(payout_fx_rate) / nullIf(toFloat64(payout_xe_fx_rate), 0)) AS payout_fx_markdown_pct,

       ( 1 - toFloat64(balance_fx_rate) / toFloat64(balance_xe_fx_rate)
    ) AS balance_fx_markdown_perct



from datamart_payout where toDate(payout_created_at) >= toDate('2025-01-01') and
payout_attempt_status = 'succeeded' and account_id in (select * from benchmark_accounts)

)
-- select * from payin_info
, 

quote as (
select a.payout_id, a.payout_attempt_id,
-- invoice_currency, charge_currency, holding_currency, settlement_currency,
a.holding_fx_quote_id, a.destination_fx_quote_id , b.quote_id, 
b.benchmark_rate, b.benchmark_pct, b."to" as to_currency, b."from" as from_currency

from datamart_payout  a 
left join datalake.clean_fx_quote b on a.destination_fx_quote_id = b.quote_id or a.holding_fx_quote_id = b.quote_id
where toDate(payout_created_at) >= toDate('2025-01-01') and
payout_attempt_status = 'succeeded' and account_id in (select * from benchmark_accounts)
-- where a.payin_id in (select payin_id from payin_info)
-- where a.account_id in (select * from benchmark_accounts)

)

select a.business_name, a.account_id, a.payout_id, a.payout_created_at, a.tpv_usd, 
from_currency, to_currency, case when benchmark_pct > 0 then 1 else 0 end as fl_is_benchmark_rate,

if(payout_currency != destination_currency, tpv_usd * payout_fx_markdown_pct,0) AS payout_fx_revenue_usd,
if(balance_currency <> payout_currency ,if(isFinite(balance_fx_markdown_perct),toDecimal128(tpv_usd * balance_fx_markdown_perct, 8),
 toDecimal128(0, 8)),toDecimal128(0, 8)) AS balance_fx_revenue_usd
, b.benchmark_rate, b.benchmark_pct,  quote_id

from payout_info a 
left join quote b on a.payout_attempt_id = b.payout_attempt_id

