WITH benchmark_accounts AS (
    SELECT DISTINCT account_id
    FROM (
        SELECT account_id, 'markup' as type, markup_pct as mark_pct
        FROM datalake.clean_config_account_fx_markup
        WHERE apply_benchmark_spread = 'true'
        UNION ALL
        SELECT account_id, 'markdown' as type, markdown_pct as mark_pct
        FROM datalake.clean_config_account_fx_markdown
        WHERE apply_benchmark_spread = 'true'
    )
    WHERE account_id NOT IN (
        'acc_cpmje7v90nmekbr0i66g',
        'acc_d51q8e1r92cb83pujstg',
        'acc_d5q65emimjo249spka40'
    )
),
payout_info AS (
    SELECT 
        p.business_name, 
        p.account_id, 
        p.payout_id, 
        p.payout_attempt_id, 
        p.payout_created_at, 
        p.balance_currency, 
        p.payout_currency, 
        p.destination_currency,
        CASE
            WHEN p.payout_currency IN ('usd', 'USD') 
                THEN p.payout_amount / 100.0
            WHEN p.payout_currency IN ('btc', 'BTC') 
                THEN (p.payout_amount / 100000000.0) * CAST(p.rate_in_pcy_to_usd AS Float64)
            ELSE (p.payout_amount / 100.0) * CAST(p.rate_in_pcy_to_usd AS Float64)
        END AS tpv_usd,
        COALESCE(1 - (toFloat64(p.payout_fx_rate) / NULLIF(toFloat64(p.payout_xe_fx_rate), 0)), 0) AS payout_fx_markdown_pct,
        COALESCE(1 - (toFloat64(p.balance_fx_rate) / NULLIF(toFloat64(p.balance_xe_fx_rate), 0)), 0) AS balance_fx_markdown_pct,
        IF(p.payout_currency <> p.destination_currency, 1, 0) AS payout_fx_flag,
        IF(p.balance_currency <> p.payout_currency, 1, 0) AS balance_fx_flag
    FROM datamart_payout p
    INNER JOIN benchmark_accounts ba ON p.account_id = ba.account_id
    WHERE p.payout_attempt_status = 'succeeded' 
      AND toDate(p.payout_created_at) >= toDate('2025-11-01')
)
-- select * from payout_info
,
quote AS (
    SELECT 
        a.payout_attempt_id,
        a.holding_fx_quote_id, 
        a.destination_fx_quote_id, 
        b.quote_id, 
        b.benchmark_rate, 
        b.benchmark_pct, 
        b."to" AS to_currency, 
        b."from" AS from_currency
    FROM datamart_payout a 
    LEFT JOIN datalake.clean_fx_quote b 
        ON a.destination_fx_quote_id = b.quote_id 
        OR a.holding_fx_quote_id = b.quote_id
    -- WHERE a.payout_attempt_id IN (SELECT payout_attempt_id FROM payout_info)
)

-- select * from quote
SELECT 
    a.business_name, 
    a.account_id, 
    a.payout_id, 
    a.payout_created_at, 
    a.balance_currency,
    a.payout_currency,
    a.destination_currency,
    a.tpv_usd,
    b.from_currency, 
    b.to_currency, 
    IF(b.benchmark_pct > 0, 1, 0) AS fl_is_benchmark_rate,
    IF(a.payout_fx_flag = 1, a.tpv_usd * a.payout_fx_markdown_pct, 0) AS payout_fx_revenue_usd,
    IF(a.balance_fx_flag = 1 AND isFinite(a.balance_fx_markdown_pct), 
        a.tpv_usd * a.balance_fx_markdown_pct, 0) AS balance_fx_revenue_usd,
    b.benchmark_rate, 
    b.benchmark_pct, 
    b.quote_id
FROM payout_info a 
LEFT JOIN quote b ON a.payout_attempt_id = b.payout_attempt_id
ORDER BY a.payout_created_at DESC
