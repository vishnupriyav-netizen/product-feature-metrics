WITH base AS (
SELECT
transaction_id,
left(transaction_id, 3) AS transaction_type,
concat(a.remitter_name, '-', a.beneficiary_name) AS ai_remitter_bene_,
a.risk_level AS ai_risk_level,
b.risk_level AS overridden_risk_level,
transaction_type IS NOT NULL AS has_txn_type
FROM datalake.clean_business_transaction_alignment a
LEFT JOIN datalake.clean_compliance_business_transaction_alignment b
ON a.remitter_name = b.remitter_name
AND a.beneficiary_name = b.beneficiary_name
AND b.updated_by NOT IN (
'divyabharthi@tazapay.com',
'vishnupriyav@tazapay.com',
'nisha@tazapay.com'
)),

biz_name_union AS (
SELECT
payin_id AS transaction_id,
business_name
FROM payin
WHERE payin_id IN (SELECT transaction_id FROM base)
UNION ALL
SELECT
payout_id AS transaction_id,
business_name
FROM datamart_payout
WHERE payout_id IN (SELECT transaction_id FROM base)
)


SELECT
business_name, 
ai_remitter_bene_,
anyIf(transaction_type, has_txn_type) AS transaction_type,
CASE max(CASE ai_risk_level
WHEN 'low' THEN 1
WHEN 'medium' THEN 2
WHEN 'high' THEN 3
WHEN 'very_high' THEN 4
END)
WHEN 1 THEN 'low'
WHEN 2 THEN 'medium'
WHEN 3 THEN 'high'
WHEN 4 THEN 'very_high'
END AS ai_risk_level,
CASE max(CASE overridden_risk_level
WHEN 'low' THEN 1
WHEN 'medium' THEN 2
WHEN 'high' THEN 3
WHEN 'very_high' THEN 4
END)
WHEN 1 THEN 'low'
WHEN 2 THEN 'medium'
WHEN 3 THEN 'high'
WHEN 4 THEN 'very_high'
END AS overridden_risk_level
FROM base a 
left join biz_name_union b on a.transaction_id = b.transaction_id
GROUP BY 1,2;
